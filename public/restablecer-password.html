<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Restablecer Contrase√±a - Tour Colombia</title>
    <link rel="stylesheet" href="regstyle.css">
    <style>
        .token-info {
            background: #e3f2fd;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
            font-size: 14px;
            color: #1976D2;
        }

        .password-requirements {
            background: #abd4cc;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .password-requirements ul {
            margin: 10px 0 0 20px;
            padding: 0;
        }
    </style>
</head>
<body>
    <div class="form-registro">
        <h2>Restablecer Contrase√±a</h2>
        <p>Ingresa tu nueva contrase√±a</p>

        <div id="tokenInfo" class="token-info"></div>

        <div id="mensaje" class="mensaje" style="display: none;"></div>

        <div class="password-requirements">
            <strong>Requisitos de la contrase√±a:</strong>
            <ul>
                <li>M√≠nimo 6 caracteres</li>
                <li>Se recomienda usar may√∫sculas, min√∫sculas y n√∫meros</li>
            </ul>
        </div>

        <form id="formRestablecer">
            <label>Nueva Contrase√±a:</label>
            <input type="password" id="nuevaPassword" class="cubos" 
                   placeholder="M√≠nimo 6 caracteres" required minlength="6">

            <label>Confirmar Contrase√±a:</label>
            <input type="password" id="confirmarPassword" class="cubos" 
                   placeholder="Repite la contrase√±a" required>

            <button type="submit" class="btn-registrar">
                üîí Restablecer Contrase√±a
            </button>
        </form>

        <a href="iniciasession.html" style="margin-top: 15px; display: block;">
            ‚Üê Volver a Iniciar Sesi√≥n
        </a>
    </div>

    <script>
        // Obtener token de la URL
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token');

        // Verificar que hay token
        if (!token) {
            mostrarMensaje('‚ö†Ô∏è Enlace inv√°lido. No se encontr√≥ el token de recuperaci√≥n.', 'error');
            document.getElementById('formRestablecer').style.display = 'none';
        } else {
            // Mostrar token (solo primeros y √∫ltimos caracteres por seguridad)
            const tokenMasked = token.substring(0, 8) + '...' + token.substring(token.length - 8);
            document.getElementById('tokenInfo').textContent = `‚úÖ Token v√°lido: ${tokenMasked}`;
        }

        document.getElementById('formRestablecer').addEventListener('submit', async (e) => {
            e.preventDefault();

            const nuevaPassword = document.getElementById('nuevaPassword').value;
            const confirmarPassword = document.getElementById('confirmarPassword').value;

            // Validar que las contrase√±as coincidan
            if (nuevaPassword !== confirmarPassword) {
                mostrarMensaje('‚ùå Las contrase√±as no coinciden', 'error');
                return;
            }

            // Validar longitud
            if (nuevaPassword.length < 6) {
                mostrarMensaje('‚ùå La contrase√±a debe tener al menos 6 caracteres', 'error');
                return;
            }

            try {
                console.log('üîí Enviando nueva contrase√±a...');
                
                const response = await fetch('http://localhost:3000/api/usuarios/restablecer-password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        token: token,
                        nuevaPassword: nuevaPassword
                    })
                });

                const resultado = await response.json();
                console.log('üì¶ Respuesta:', resultado);

                if (resultado.success) {
                    mostrarMensaje('‚úÖ ' + resultado.message, 'exito');
                    
                    // Redirigir al login despu√©s de 2 segundos
                    setTimeout(() => {
                        window.location.href = 'iniciasession.html';
                    }, 2000);
                } else {
                    mostrarMensaje('‚ùå ' + resultado.message, 'error');
                }

            } catch (error) {
                console.error('‚ùå Error:', error);
                mostrarMensaje('Error de conexi√≥n con el servidor', 'error');
            }
        });

        function mostrarMensaje(texto, tipo) {
            const mensaje = document.getElementById('mensaje');
            mensaje.textContent = texto;
            mensaje.className = 'mensaje ' + tipo;
            mensaje.style.display = 'block';

            // Scroll hacia el mensaje
            mensaje.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    </script>
</body>
</html>